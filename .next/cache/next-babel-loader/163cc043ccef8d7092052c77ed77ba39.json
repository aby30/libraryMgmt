{"ast":null,"code":"import openDB from '../../../backend/configs/database/dao';\nimport BookRepo from '../../../backend/repositories/bookRepo';\nimport UserDetails from '../getUserDetails';\nexport default (async (req, res) => {\n  const db = await openDB();\n  const reqBody = JSON.parse(req.body);\n  let bookIds = '';\n  const userCurrentData = await UserDetails({\n    body: JSON.stringify({\n      userId: reqBody.userId\n    })\n  });\n  const bookIdsBorrowed = userCurrentData.bookIds.split(',');\n  const currentBooks = bookIdsBorrowed.filter(id => parseInt(id) !== reqBody.cartData.bookId) || [];\n\n  if (currentBooks.length < 2 && reqBody.cartData.bookId) {\n    // const statement = await db.prepare('UPDATE books SET availableQty= ? where bookId= ? ');\n    // const result = await statement.run(\n    //     reqBody.cartData.availableQty+1,\n    //     reqBody.cartData.bookId,\n    // )\n    // result.finalize();\n    await BookRepo.update({\n      bookId: reqBody.cartData.bookId,\n      availableQty: reqBody.cartData.availableQty + 1\n    });\n    if (bookIds.length === 0) bookIds = reqBody.cartData.bookId.toString();else bookIds = bookIds.concat(`,${reqBody.cartData.bookId.toString()}`);\n    const userUpdateStatement = await db.prepare('UPDATE Users SET bookIds= ? where userId= ? ');\n    const userUpdateResult = await userUpdateStatement.run(currentBooks[0] || '', reqBody.userId);\n    userUpdateResult.finalize();\n    res.statusCode = 200;\n    res.json({\n      data: 'Returned succesfully'\n    });\n  } else {\n    res.json({\n      data: 'Cannot be returned'\n    });\n  }\n});","map":{"version":3,"sources":["/Users/Abhipray 1/Desktop/MY home/mYY work/HEXAD_assignment/Hexad_trial_code/hexd/pages/api/returnBook/index.js"],"names":["openDB","BookRepo","UserDetails","req","res","db","reqBody","JSON","parse","body","bookIds","userCurrentData","stringify","userId","bookIdsBorrowed","split","currentBooks","filter","id","parseInt","cartData","bookId","length","update","availableQty","toString","concat","userUpdateStatement","prepare","userUpdateResult","run","finalize","statusCode","json","data"],"mappings":"AAAA,OAAOA,MAAP,MAAmB,uCAAnB;AACA,OAAOC,QAAP,MAAqB,wCAArB;AACA,OAAOC,WAAP,MAAwB,mBAAxB;AAEA,gBAAe,OAAOC,GAAP,EAAYC,GAAZ,KAAoB;AACjC,QAAMC,EAAE,GAAG,MAAML,MAAM,EAAvB;AACA,QAAMM,OAAO,GAAGC,IAAI,CAACC,KAAL,CAAWL,GAAG,CAACM,IAAf,CAAhB;AACA,MAAIC,OAAO,GAAG,EAAd;AACA,QAAMC,eAAe,GAAG,MAAMT,WAAW,CAAC;AAACO,IAAAA,IAAI,EAAEF,IAAI,CAACK,SAAL,CAAe;AAAEC,MAAAA,MAAM,EAAEP,OAAO,CAACO;AAAlB,KAAf;AAAP,GAAD,CAAzC;AAEA,QAAMC,eAAe,GAAGH,eAAe,CAACD,OAAhB,CAAwBK,KAAxB,CAA8B,GAA9B,CAAxB;AACA,QAAMC,YAAY,GAAGF,eAAe,CAACG,MAAhB,CAAuBC,EAAE,IAAIC,QAAQ,CAACD,EAAD,CAAR,KAAiBZ,OAAO,CAACc,QAAR,CAAiBC,MAA/D,KAA0E,EAA/F;;AAEA,MAAIL,YAAY,CAACM,MAAb,GAAsB,CAAtB,IAA2BhB,OAAO,CAACc,QAAR,CAAiBC,MAAhD,EAAwD;AAEtD;AACA;AACA;AACA;AACA;AACA;AACA,UAAMpB,QAAQ,CAACsB,MAAT,CAAgB;AACpBF,MAAAA,MAAM,EAAEf,OAAO,CAACc,QAAR,CAAiBC,MADL;AAEpBG,MAAAA,YAAY,EAAElB,OAAO,CAACc,QAAR,CAAiBI,YAAjB,GAA8B;AAFxB,KAAhB,CAAN;AAKA,QAAId,OAAO,CAACY,MAAR,KAAmB,CAAvB,EACIZ,OAAO,GAAGJ,OAAO,CAACc,QAAR,CAAiBC,MAAjB,CAAwBI,QAAxB,EAAV,CADJ,KAGIf,OAAO,GAAGA,OAAO,CAACgB,MAAR,CAAgB,IAAGpB,OAAO,CAACc,QAAR,CAAiBC,MAAjB,CAAwBI,QAAxB,EAAmC,EAAtD,CAAV;AAEJ,UAAME,mBAAmB,GAAG,MAAMtB,EAAE,CAACuB,OAAH,CAAW,8CAAX,CAAlC;AACA,UAAMC,gBAAgB,GAAG,MAAMF,mBAAmB,CAACG,GAApB,CAC3Bd,YAAY,CAAC,CAAD,CAAZ,IAAmB,EADQ,EAE3BV,OAAO,CAACO,MAFmB,CAA/B;AAIAgB,IAAAA,gBAAgB,CAACE,QAAjB;AAEA3B,IAAAA,GAAG,CAAC4B,UAAJ,GAAiB,GAAjB;AACA5B,IAAAA,GAAG,CAAC6B,IAAJ,CAAS;AACPC,MAAAA,IAAI,EAAE;AADC,KAAT;AAID,GA9BD,MA8BO;AACL9B,IAAAA,GAAG,CAAC6B,IAAJ,CAAS;AACPC,MAAAA,IAAI,EAAE;AADC,KAAT;AAGD;AAGF,CA9CD","sourcesContent":["import openDB from '../../../backend/configs/database/dao';\nimport BookRepo from '../../../backend/repositories/bookRepo';\nimport UserDetails from '../getUserDetails';\n\nexport default async (req, res) => {\n  const db = await openDB();\n  const reqBody = JSON.parse(req.body);\n  let bookIds = '';\n  const userCurrentData = await UserDetails({body: JSON.stringify({ userId: reqBody.userId })});\n\n  const bookIdsBorrowed = userCurrentData.bookIds.split(',')\n  const currentBooks = bookIdsBorrowed.filter(id => parseInt(id) !== reqBody.cartData.bookId) || [];\n\n  if (currentBooks.length < 2 && reqBody.cartData.bookId) {\n\n    // const statement = await db.prepare('UPDATE books SET availableQty= ? where bookId= ? ');\n    // const result = await statement.run(\n    //     reqBody.cartData.availableQty+1,\n    //     reqBody.cartData.bookId,\n    // )\n    // result.finalize();\n    await BookRepo.update({\n      bookId: reqBody.cartData.bookId,\n      availableQty: reqBody.cartData.availableQty+1,\n    });\n\n    if (bookIds.length === 0)\n        bookIds = reqBody.cartData.bookId.toString()\n    else\n        bookIds = bookIds.concat(`,${reqBody.cartData.bookId.toString()}`)\n\n    const userUpdateStatement = await db.prepare('UPDATE Users SET bookIds= ? where userId= ? ');\n    const userUpdateResult = await userUpdateStatement.run(\n        currentBooks[0] || '',\n        reqBody.userId,\n    )\n    userUpdateResult.finalize();\n\n    res.statusCode = 200;\n    res.json({ \n      data: 'Returned succesfully',\n    });\n\n  } else {\n    res.json({ \n      data: 'Cannot be returned',\n    });\n  }\n\n  \n}\n"]},"metadata":{},"sourceType":"module"}