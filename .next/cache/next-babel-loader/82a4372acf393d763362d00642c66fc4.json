{"ast":null,"code":"// import openDB from '../../../backend/configs/database/dao';\nimport BookRepo from '../../../backend/repositories/bookRepo';\nimport UserRepo from '../../../backend/repositories/userRepo';\nimport UserDetails from '../getUserDetails';\nexport default (async (req, res) => {\n  // const db = await openDB();\n  const reqBody = JSON.parse(req.body);\n  const userCurrentData = await UserDetails({\n    body: JSON.stringify({\n      userId: reqBody.userId\n    })\n  });\n  let bookIds = userCurrentData.bookIds || '';\n  const currentBooks = userCurrentData.bookIds.length > 0 ? userCurrentData.bookIds.split(',') : '';\n\n  if (currentBooks.length + reqBody.cartData.length < 3 && reqBody.cartData.length > 0) {\n    // if (reqBody.cartData.length > 0) {\n    for (let index = 0; index < reqBody.cartData.length; index++) {\n      // const statement = await db.prepare('UPDATE books SET availableQty= ? where bookId= ? ');\n      // const result = await statement.run(\n      //     reqBody.cartData[index].availableQty-1,\n      //     reqBody.cartData[index].bookId,\n      // );\n      // result.finalize();\n      await BookRepo.update({\n        bookId: reqBody.cartData[index].bookId,\n        availableQty: reqBody.cartData[index].availableQty - 1\n      });\n      if (bookIds.length === 0) bookIds = reqBody.cartData[index].bookId.toString();else bookIds = bookIds.concat(`,${reqBody.cartData[index].bookId.toString()}`);\n    } // }\n    // const userUpdateStatement = await db.prepare('UPDATE Users SET bookIds= ? where userId= ? ');\n    // const userUpdateResult = await userUpdateStatement.run(\n    //     bookIds,\n    //     reqBody.userId,\n    // );\n    // userUpdateResult.finalize();\n\n\n    await UserRepo.update({\n      bookId: bookIds,\n      userId: reqBody.userId\n    });\n    res.statusCode = 200;\n    res.json({\n      data: 'Borrowed succesfully',\n      maxLimit: false\n    });\n  } else {\n    res.json({\n      data: 'Max limit of books already borrowed',\n      maxLimit: true\n    });\n  }\n});","map":{"version":3,"sources":["/Users/Abhipray 1/Desktop/MY home/mYY work/HEXAD_assignment/Hexad_trial_code/hexd/pages/api/borrowBooks/index.js"],"names":["BookRepo","UserRepo","UserDetails","req","res","reqBody","JSON","parse","body","userCurrentData","stringify","userId","bookIds","currentBooks","length","split","cartData","index","update","bookId","availableQty","toString","concat","statusCode","json","data","maxLimit"],"mappings":"AAAA;AACA,OAAOA,QAAP,MAAqB,wCAArB;AACA,OAAOC,QAAP,MAAqB,wCAArB;AACA,OAAOC,WAAP,MAAwB,mBAAxB;AAEA,gBAAe,OAAOC,GAAP,EAAYC,GAAZ,KAAoB;AACjC;AACA,QAAMC,OAAO,GAAGC,IAAI,CAACC,KAAL,CAAWJ,GAAG,CAACK,IAAf,CAAhB;AACA,QAAMC,eAAe,GAAG,MAAMP,WAAW,CAAC;AAACM,IAAAA,IAAI,EAAEF,IAAI,CAACI,SAAL,CAAe;AAAEC,MAAAA,MAAM,EAAEN,OAAO,CAACM;AAAlB,KAAf;AAAP,GAAD,CAAzC;AACA,MAAIC,OAAO,GAAGH,eAAe,CAACG,OAAhB,IAA2B,EAAzC;AAEA,QAAMC,YAAY,GAAGJ,eAAe,CAACG,OAAhB,CAAwBE,MAAxB,GAAiC,CAAjC,GAAqCL,eAAe,CAACG,OAAhB,CAAwBG,KAAxB,CAA8B,GAA9B,CAArC,GAA0E,EAA/F;;AAEA,MAAKF,YAAY,CAACC,MAAb,GAAsBT,OAAO,CAACW,QAAR,CAAiBF,MAAxC,GAAkD,CAAlD,IAAuDT,OAAO,CAACW,QAAR,CAAiBF,MAAjB,GAA0B,CAArF,EAAwF;AAEtF;AACE,SAAK,IAAIG,KAAK,GAAG,CAAjB,EAAoBA,KAAK,GAAGZ,OAAO,CAACW,QAAR,CAAiBF,MAA7C,EAAqDG,KAAK,EAA1D,EAA8D;AAC1D;AACA;AACA;AACA;AACA;AACA;AACA,YAAMjB,QAAQ,CAACkB,MAAT,CAAgB;AACpBC,QAAAA,MAAM,EAAEd,OAAO,CAACW,QAAR,CAAiBC,KAAjB,EAAwBE,MADZ;AAEpBC,QAAAA,YAAY,EAAEf,OAAO,CAACW,QAAR,CAAiBC,KAAjB,EAAwBG,YAAxB,GAAqC;AAF/B,OAAhB,CAAN;AAIA,UAAIR,OAAO,CAACE,MAAR,KAAmB,CAAvB,EACIF,OAAO,GAAGP,OAAO,CAACW,QAAR,CAAiBC,KAAjB,EAAwBE,MAAxB,CAA+BE,QAA/B,EAAV,CADJ,KAGIT,OAAO,GAAGA,OAAO,CAACU,MAAR,CAAgB,IAAGjB,OAAO,CAACW,QAAR,CAAiBC,KAAjB,EAAwBE,MAAxB,CAA+BE,QAA/B,EAA0C,EAA7D,CAAV;AACP,KAlBmF,CAmBtF;AAEA;AACA;AACA;AACA;AACA;AACA;;;AACA,UAAMpB,QAAQ,CAACiB,MAAT,CAAgB;AACpBC,MAAAA,MAAM,EAAEP,OADY;AAEpBD,MAAAA,MAAM,EAAEN,OAAO,CAACM;AAFI,KAAhB,CAAN;AAKAP,IAAAA,GAAG,CAACmB,UAAJ,GAAiB,GAAjB;AACAnB,IAAAA,GAAG,CAACoB,IAAJ,CAAS;AACPC,MAAAA,IAAI,EAAE,sBADC;AAEPC,MAAAA,QAAQ,EAAE;AAFH,KAAT;AAKD,GAtCD,MAsCO;AACLtB,IAAAA,GAAG,CAACoB,IAAJ,CAAS;AACPC,MAAAA,IAAI,EAAE,qCADC;AAEPC,MAAAA,QAAQ,EAAE;AAFH,KAAT;AAID;AAGF,CAtDD","sourcesContent":["// import openDB from '../../../backend/configs/database/dao';\nimport BookRepo from '../../../backend/repositories/bookRepo';\nimport UserRepo from '../../../backend/repositories/userRepo';\nimport UserDetails from '../getUserDetails';\n\nexport default async (req, res) => {\n  // const db = await openDB();\n  const reqBody = JSON.parse(req.body);\n  const userCurrentData = await UserDetails({body: JSON.stringify({ userId: reqBody.userId })});\n  let bookIds = userCurrentData.bookIds || '';\n\n  const currentBooks = userCurrentData.bookIds.length > 0 ? userCurrentData.bookIds.split(',') : '';\n\n  if ((currentBooks.length + reqBody.cartData.length) < 3 && reqBody.cartData.length > 0) {\n\n    // if (reqBody.cartData.length > 0) {\n      for (let index = 0; index < reqBody.cartData.length; index++) {\n          // const statement = await db.prepare('UPDATE books SET availableQty= ? where bookId= ? ');\n          // const result = await statement.run(\n          //     reqBody.cartData[index].availableQty-1,\n          //     reqBody.cartData[index].bookId,\n          // );\n          // result.finalize();\n          await BookRepo.update({\n            bookId: reqBody.cartData[index].bookId,\n            availableQty: reqBody.cartData[index].availableQty-1,\n          });\n          if (bookIds.length === 0)\n              bookIds = reqBody.cartData[index].bookId.toString();\n          else\n              bookIds = bookIds.concat(`,${reqBody.cartData[index].bookId.toString()}`);\n      }\n    // }\n\n    // const userUpdateStatement = await db.prepare('UPDATE Users SET bookIds= ? where userId= ? ');\n    // const userUpdateResult = await userUpdateStatement.run(\n    //     bookIds,\n    //     reqBody.userId,\n    // );\n    // userUpdateResult.finalize();\n    await UserRepo.update({\n      bookId: bookIds,\n      userId: reqBody.userId,\n    });\n\n    res.statusCode = 200;\n    res.json({ \n      data: 'Borrowed succesfully',\n      maxLimit: false,\n    });\n\n  } else {\n    res.json({ \n      data: 'Max limit of books already borrowed',\n      maxLimit: true,\n    });\n  }\n\n  \n}\n"]},"metadata":{},"sourceType":"module"}